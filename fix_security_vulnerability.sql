-- ğŸš¨ ê¸´ê¸‰ ë³´ì•ˆ ìˆ˜ì •: ì‚¬ìš©ì ë°ì´í„° ê²©ë¦¬
-- ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” Supabase SQL Editorì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”
-- ì‹¤í–‰ ì „ì— ê¸°ì¡´ ë°ì´í„°ë¥¼ ë°±ì—…í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤

-- 1. reviews í…Œì´ë¸”ì— user_id ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE reviews 
ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE;

-- 2. ebooks í…Œì´ë¸”ì— user_id ì»¬ëŸ¼ ì¶”ê°€  
ALTER TABLE ebooks 
ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE;

-- 3. reading_goals í…Œì´ë¸” í™•ì¸ (ì´ë¯¸ user_idê°€ ìˆì„ ìˆ˜ ìˆìŒ)
-- ALTER TABLE reading_goals 
-- ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE;

-- 4. ê¸°ì¡´ RLS ì •ì±…ë“¤ ì œê±° (ë³´ì•ˆìƒ ìœ„í—˜í•œ ì •ì±…ë“¤)
DROP POLICY IF EXISTS "Users can view all ebooks" ON ebooks;
DROP POLICY IF EXISTS "Users can insert ebooks" ON ebooks;
DROP POLICY IF EXISTS "Users can update ebooks" ON ebooks;
DROP POLICY IF EXISTS "Users can delete ebooks" ON ebooks;
DROP POLICY IF EXISTS "Users can view all achievements" ON achievements;
DROP POLICY IF EXISTS "Users can update achievements" ON achievements;
DROP POLICY IF EXISTS "Users can manage their goals" ON reading_goals;

-- 5. reviews í…Œì´ë¸”ì— ëŒ€í•œ ì˜¬ë°”ë¥¸ RLS ì •ì±… ìƒì„±
CREATE POLICY "Users can view own reviews" ON reviews 
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own reviews" ON reviews 
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own reviews" ON reviews 
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own reviews" ON reviews 
  FOR DELETE USING (auth.uid() = user_id);

-- 6. ebooks í…Œì´ë¸”ì— ëŒ€í•œ ì˜¬ë°”ë¥¸ RLS ì •ì±… ìƒì„±
CREATE POLICY "Users can view own ebooks" ON ebooks 
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own ebooks" ON ebooks 
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own ebooks" ON ebooks 
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own ebooks" ON ebooks 
  FOR DELETE USING (auth.uid() = user_id);

-- 7. reading_goals í…Œì´ë¸”ì— ëŒ€í•œ ì˜¬ë°”ë¥¸ RLS ì •ì±… ìƒì„±
CREATE POLICY "Users can view own reading goals" ON reading_goals 
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own reading goals" ON reading_goals 
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own reading goals" ON reading_goals 
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own reading goals" ON reading_goals 
  FOR DELETE USING (auth.uid() = user_id);

-- 8. achievements í…Œì´ë¸”ì€ ëª¨ë“  ì‚¬ìš©ìê°€ ë³¼ ìˆ˜ ìˆë„ë¡ ìœ ì§€ (ì—…ì ì€ ê³µí†µ ë°ì´í„°)
CREATE POLICY "All users can view achievements" ON achievements 
  FOR SELECT USING (true);

-- 9. RLS í™œì„±í™” í™•ì¸
ALTER TABLE reviews ENABLE ROW LEVEL SECURITY;
ALTER TABLE ebooks ENABLE ROW LEVEL SECURITY;
ALTER TABLE reading_goals ENABLE ROW LEVEL SECURITY;
ALTER TABLE achievements ENABLE ROW LEVEL SECURITY;

-- 10. ì¸ë±ìŠ¤ ìƒì„± (ì„±ëŠ¥ í–¥ìƒ)
CREATE INDEX IF NOT EXISTS idx_reviews_user_id ON reviews(user_id);
CREATE INDEX IF NOT EXISTS idx_ebooks_user_id ON ebooks(user_id);
CREATE INDEX IF NOT EXISTS idx_reading_goals_user_id ON reading_goals(user_id);

-- âš ï¸  ì¤‘ìš”í•œ ì£¼ì˜ì‚¬í•­:
-- 1. ê¸°ì¡´ ë°ì´í„°ì— user_idê°€ NULLì¸ ê²½ìš°, í•´ë‹¹ ë°ì´í„°ëŠ” ì¡°íšŒë˜ì§€ ì•ŠìŠµë‹ˆë‹¤
-- 2. ê¸°ì¡´ ë°ì´í„°ë¥¼ íŠ¹ì • ì‚¬ìš©ìì—ê²Œ í• ë‹¹í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:
-- 
-- UPDATE reviews SET user_id = '[ì‚¬ìš©ì_UUID]' WHERE user_id IS NULL;
-- UPDATE ebooks SET user_id = '[ì‚¬ìš©ì_UUID]' WHERE user_id IS NULL;
--
-- 3. ë˜ëŠ” ê¸°ì¡´ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì‹œì‘í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:
-- 
-- DELETE FROM reviews WHERE user_id IS NULL;
-- DELETE FROM ebooks WHERE user_id IS NULL;

COMMENT ON COLUMN reviews.user_id IS 'ë¦¬ë·° ì‘ì„±ì ID - ì‚¬ìš©ìë³„ ë°ì´í„° ê²©ë¦¬ë¥¼ ìœ„í•´ ì¶”ê°€';
COMMENT ON COLUMN ebooks.user_id IS 'ì „ìì±… ì†Œìœ ì ID - ì‚¬ìš©ìë³„ ë°ì´í„° ê²©ë¦¬ë¥¼ ìœ„í•´ ì¶”ê°€';

-- ì™„ë£Œ ë©”ì‹œì§€
DO $$
BEGIN
  RAISE NOTICE 'ğŸš¨ ë³´ì•ˆ ì·¨ì•½ì  ìˆ˜ì • ì™„ë£Œ!';
  RAISE NOTICE 'âœ… ì´ì œ ì‚¬ìš©ìë³„ë¡œ ë°ì´í„°ê°€ ê²©ë¦¬ë˜ì–´ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
  RAISE NOTICE 'âš ï¸  ê¸°ì¡´ ë°ì´í„°ì— user_idë¥¼ í• ë‹¹í•˜ê±°ë‚˜ ì‚­ì œí•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
END $$;
