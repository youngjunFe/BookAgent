-- ğŸš¨ğŸš¨ğŸš¨ ìµœê°• ë³´ì•ˆ ìˆ˜ì •: ì‚¬ìš©ì ë°ì´í„° ì™„ì „ ê²©ë¦¬ ğŸš¨ğŸš¨ğŸš¨
-- ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” Supabase SQL Editorì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”
-- âš ï¸  ìœ„í—˜: ê¸°ì¡´ ë°ì´í„°ê°€ ì‚­ì œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°±ì—… í›„ ì‹¤í–‰í•˜ì„¸ìš”!

BEGIN;

-- ==================== 1. ê¸°ì¡´ ìœ„í—˜í•œ ì •ì±…ë“¤ ëª¨ë‘ ì œê±° ====================
DROP POLICY IF EXISTS "Users can view all ebooks" ON ebooks;
DROP POLICY IF EXISTS "Users can insert ebooks" ON ebooks;
DROP POLICY IF EXISTS "Users can update ebooks" ON ebooks;
DROP POLICY IF EXISTS "Users can delete ebooks" ON ebooks;
DROP POLICY IF EXISTS "Users can view all achievements" ON achievements;
DROP POLICY IF EXISTS "Users can update achievements" ON achievements;
DROP POLICY IF EXISTS "Users can manage their goals" ON reading_goals;
DROP POLICY IF EXISTS "Users can view own reviews" ON reviews;
DROP POLICY IF EXISTS "Users can insert own reviews" ON reviews;
DROP POLICY IF EXISTS "Users can update own reviews" ON reviews;
DROP POLICY IF EXISTS "Users can delete own reviews" ON reviews;
DROP POLICY IF EXISTS "Users can view own ebooks" ON ebooks;
DROP POLICY IF EXISTS "Users can insert own ebooks" ON ebooks;
DROP POLICY IF EXISTS "Users can update own ebooks" ON ebooks;
DROP POLICY IF EXISTS "Users can delete own ebooks" ON ebooks;
DROP POLICY IF EXISTS "Users can view own reading goals" ON reading_goals;
DROP POLICY IF EXISTS "Users can insert own reading goals" ON reading_goals;
DROP POLICY IF EXISTS "Users can update own reading goals" ON reading_goals;
DROP POLICY IF EXISTS "Users can delete own reading goals" ON reading_goals;
DROP POLICY IF EXISTS "All users can view achievements" ON achievements;

-- ==================== 2. í…Œì´ë¸” ì»¬ëŸ¼ ì¶”ê°€ ====================
-- reviews í…Œì´ë¸”ì— user_id ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE reviews 
ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE;

-- ebooks í…Œì´ë¸”ì— user_id ì»¬ëŸ¼ ì¶”ê°€  
ALTER TABLE ebooks 
ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE;

-- reading_goals í…Œì´ë¸”ì— user_id ì»¬ëŸ¼ ì¶”ê°€ (ì´ë¯¸ ìˆì„ ìˆ˜ ìˆì§€ë§Œ í™•ì‹¤íˆ)
ALTER TABLE reading_goals 
ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE;

-- ==================== 3. ê¸°ì¡´ ë°ì´í„° ì •ë¦¬ (ìœ„í—˜!) ====================
-- âš ï¸  ê²½ê³ : ì´ ë¶€ë¶„ì€ ê¸°ì¡´ ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤!
-- í•„ìš”í•œ ê²½ìš° ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”

-- ë°©ë²• 1: user_idê°€ NULLì¸ ëª¨ë“  ë°ì´í„° ì‚­ì œ (ì¶”ì²œ)
DELETE FROM reviews WHERE user_id IS NULL;
DELETE FROM ebooks WHERE user_id IS NULL;
DELETE FROM reading_goals WHERE user_id IS NULL;

-- ë°©ë²• 2: íŠ¹ì • ì‚¬ìš©ìì—ê²Œ í• ë‹¹í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
-- UPDATE reviews SET user_id = '[ì‹¤ì œ_ì‚¬ìš©ì_UUID]' WHERE user_id IS NULL;
-- UPDATE ebooks SET user_id = '[ì‹¤ì œ_ì‚¬ìš©ì_UUID]' WHERE user_id IS NULL;
-- UPDATE reading_goals SET user_id = '[ì‹¤ì œ_ì‚¬ìš©ì_UUID]' WHERE user_id IS NULL;

-- ==================== 4. ìµœê°• RLS ì •ì±… ìƒì„± ====================

-- reviews í…Œì´ë¸” - ì² ì €í•œ ì‚¬ìš©ì ê²©ë¦¬
CREATE POLICY "STRICT_reviews_select" ON reviews 
  FOR SELECT USING (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  );

CREATE POLICY "STRICT_reviews_insert" ON reviews 
  FOR INSERT WITH CHECK (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  );

CREATE POLICY "STRICT_reviews_update" ON reviews 
  FOR UPDATE USING (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  ) WITH CHECK (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  );

CREATE POLICY "STRICT_reviews_delete" ON reviews 
  FOR DELETE USING (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  );

-- ebooks í…Œì´ë¸” - ì² ì €í•œ ì‚¬ìš©ì ê²©ë¦¬
CREATE POLICY "STRICT_ebooks_select" ON ebooks 
  FOR SELECT USING (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  );

CREATE POLICY "STRICT_ebooks_insert" ON ebooks 
  FOR INSERT WITH CHECK (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  );

CREATE POLICY "STRICT_ebooks_update" ON ebooks 
  FOR UPDATE USING (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  ) WITH CHECK (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  );

CREATE POLICY "STRICT_ebooks_delete" ON ebooks 
  FOR DELETE USING (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  );

-- reading_goals í…Œì´ë¸” - ì² ì €í•œ ì‚¬ìš©ì ê²©ë¦¬
CREATE POLICY "STRICT_reading_goals_select" ON reading_goals 
  FOR SELECT USING (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  );

CREATE POLICY "STRICT_reading_goals_insert" ON reading_goals 
  FOR INSERT WITH CHECK (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  );

CREATE POLICY "STRICT_reading_goals_update" ON reading_goals 
  FOR UPDATE USING (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  ) WITH CHECK (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  );

CREATE POLICY "STRICT_reading_goals_delete" ON reading_goals 
  FOR DELETE USING (
    auth.uid() IS NOT NULL AND auth.uid() = user_id
  );

-- achievementsëŠ” ëª¨ë“  ì‚¬ìš©ìê°€ ë³¼ ìˆ˜ ìˆì§€ë§Œ ìˆ˜ì •ì€ ë¶ˆê°€
CREATE POLICY "PUBLIC_achievements_select" ON achievements 
  FOR SELECT USING (true);

-- ==================== 5. RLS ê°•ì œ í™œì„±í™” ====================
ALTER TABLE reviews ENABLE ROW LEVEL SECURITY;
ALTER TABLE ebooks ENABLE ROW LEVEL SECURITY;
ALTER TABLE reading_goals ENABLE ROW LEVEL SECURITY;
ALTER TABLE achievements ENABLE ROW LEVEL SECURITY;

-- ==================== 6. NOT NULL ì œì•½ì¡°ê±´ ì¶”ê°€ (ìµœê°• ë³´ì•ˆ) ====================
-- ìƒˆë¡œìš´ ë°ì´í„°ëŠ” ë°˜ë“œì‹œ user_idê°€ ìˆì–´ì•¼ í•¨
-- âš ï¸  ì£¼ì˜: ê¸°ì¡´ ë°ì´í„°ê°€ ëª¨ë‘ ì •ë¦¬ëœ í›„ì—ë§Œ ì‹¤í–‰

-- ê¸°ì¡´ NULL ë°ì´í„°ê°€ ëª¨ë‘ ì •ë¦¬ë˜ì—ˆëŠ”ì§€ í™•ì¸
DO $$ 
BEGIN
  IF EXISTS (SELECT 1 FROM reviews WHERE user_id IS NULL) THEN
    RAISE EXCEPTION 'reviews í…Œì´ë¸”ì— user_idê°€ NULLì¸ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ì •ë¦¬í•˜ì„¸ìš”.';
  END IF;
  
  IF EXISTS (SELECT 1 FROM ebooks WHERE user_id IS NULL) THEN
    RAISE EXCEPTION 'ebooks í…Œì´ë¸”ì— user_idê°€ NULLì¸ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ì •ë¦¬í•˜ì„¸ìš”.';
  END IF;
  
  -- ëª¨ë“  ë°ì´í„°ê°€ ì •ë¦¬ë˜ì—ˆìœ¼ë©´ NOT NULL ì œì•½ì¡°ê±´ ì¶”ê°€
  ALTER TABLE reviews ALTER COLUMN user_id SET NOT NULL;
  ALTER TABLE ebooks ALTER COLUMN user_id SET NOT NULL;
  -- reading_goalsëŠ” ì´ë¯¸ NOT NULLì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¡°ê±´ë¶€ ì‹¤í–‰
  BEGIN
    ALTER TABLE reading_goals ALTER COLUMN user_id SET NOT NULL;
  EXCEPTION WHEN OTHERS THEN
    -- ì´ë¯¸ NOT NULLì´ë©´ ë¬´ì‹œ
    NULL;
  END;
  
  RAISE NOTICE 'âœ… NOT NULL ì œì•½ì¡°ê±´ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.';
END $$;

-- ==================== 7. ì¸ë±ìŠ¤ ìƒì„± (ì„±ëŠ¥ ìµœì í™”) ====================
CREATE INDEX IF NOT EXISTS idx_reviews_user_id ON reviews(user_id);
CREATE INDEX IF NOT EXISTS idx_ebooks_user_id ON ebooks(user_id);
CREATE INDEX IF NOT EXISTS idx_reading_goals_user_id ON reading_goals(user_id);

-- ==================== 8. ê¶Œí•œ ê²€ì¦ í•¨ìˆ˜ ====================
CREATE OR REPLACE FUNCTION check_user_owns_review(review_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM reviews 
    WHERE id = review_id 
      AND user_id = auth.uid()
      AND auth.uid() IS NOT NULL
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION check_user_owns_ebook(ebook_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM ebooks 
    WHERE id = ebook_id 
      AND user_id = auth.uid()
      AND auth.uid() IS NOT NULL
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ==================== 9. ìµœì¢… ê²€ì¦ ====================
DO $$
DECLARE
  review_count INTEGER;
  ebook_count INTEGER;
  goal_count INTEGER;
BEGIN
  -- ê° í…Œì´ë¸”ì˜ ë°ì´í„° ìƒíƒœ í™•ì¸
  SELECT COUNT(*) INTO review_count FROM reviews WHERE user_id IS NULL;
  SELECT COUNT(*) INTO ebook_count FROM ebooks WHERE user_id IS NULL;
  SELECT COUNT(*) INTO goal_count FROM reading_goals WHERE user_id IS NULL;
  
  RAISE NOTICE 'ğŸ” ë³´ì•ˆ ê²€ì¦ ê²°ê³¼:';
  RAISE NOTICE '- user_idê°€ NULLì¸ reviews: %ê°œ', review_count;
  RAISE NOTICE '- user_idê°€ NULLì¸ ebooks: %ê°œ', ebook_count;
  RAISE NOTICE '- user_idê°€ NULLì¸ reading_goals: %ê°œ', goal_count;
  
  IF review_count = 0 AND ebook_count = 0 AND goal_count = 0 THEN
    RAISE NOTICE 'âœ… ëª¨ë“  ë°ì´í„°ê°€ ì‚¬ìš©ìë³„ë¡œ ê²©ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
  ELSE
    RAISE NOTICE 'âš ï¸  ì•„ì§ NULL ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì •ë¦¬í•˜ì„¸ìš”.';
  END IF;
END $$;

COMMIT;

-- ğŸ‰ ì™„ë£Œ ë©”ì‹œì§€
DO $$
BEGIN
  RAISE NOTICE 'ğŸš¨ğŸš¨ğŸš¨ ìµœê°• ë³´ì•ˆ ì„¤ì • ì™„ë£Œ! ğŸš¨ğŸš¨ğŸš¨';
  RAISE NOTICE 'âœ… ì‚¬ìš©ìë³„ ì™„ì „ ë°ì´í„° ê²©ë¦¬ ì ìš©ë¨';
  RAISE NOTICE 'âœ… ë¹„ì¸ì¦ ì‚¬ìš©ì ì ‘ê·¼ ì™„ì „ ì°¨ë‹¨';
  RAISE NOTICE 'âœ… RLS ì •ì±… ìµœê³  ìˆ˜ì¤€ìœ¼ë¡œ ê°•í™”';
  RAISE NOTICE 'âš ï¸  ì´ì œ ì•±ì„ ì¬ì‹œì‘í•˜ê³  ë‹¤ë¥¸ ê³„ì •ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”!';
END $$;
